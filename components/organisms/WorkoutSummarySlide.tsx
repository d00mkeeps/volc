import React, { useState } from "react";
import { YStack, Text, Input, Button, TextArea, XStack } from "tamagui";
import { useUserSessionStore } from "@/stores/userSessionStore";
import { useWorkoutStore } from "@/stores/workout/WorkoutStore";
import ImagePickerButton from "../atoms/buttons/ImagePickerButton";
import WorkoutImage from "../molecules/WorkoutImage";
import { imageService } from "@/services/api/imageService";

interface WorkoutSummarySlideProps {
  onContinue: () => void;
  showContinueButton?: boolean;
}

export function WorkoutSummarySlide({
  onContinue,
  showContinueButton = true,
}: WorkoutSummarySlideProps) {
  const {
    currentWorkout,
    updateCurrentWorkout,
    pendingImageId,
    setPendingImage,
    selectedTemplate,
  } = useUserSessionStore();
  const { updateWorkout } = useWorkoutStore();

  const [workoutName, setWorkoutName] = useState("");
  const [showNameError, setShowNameError] = useState(false);
  const [workoutNotes, setWorkoutNotes] = useState(() => {
    console.log("=== WORKOUT SUMMARY DEBUG ===");
    console.log("currentWorkout:", currentWorkout);
    console.log("workout_exercises:", currentWorkout?.workout_exercises);
    console.log(
      "Type of workout_exercises:",
      typeof currentWorkout?.workout_exercises
    );

    if (currentWorkout?.notes) {
      return currentWorkout.notes;
    }

    // Safe fallback with logging
    const exercises = currentWorkout?.workout_exercises || [];
    console.log("Using exercises fallback:", exercises);

    return (
      exercises.map((exercise) => `${exercise.name}:\n\n`).join("\n") || ""
    );
  });

  const handleNameChange = (name: string) => {
    setWorkoutName(name);
    if (currentWorkout) {
      updateCurrentWorkout({
        ...currentWorkout,
        name,
        updated_at: new Date().toISOString(),
      });
    }
  };

  const handleImageUploaded = (imageId: string) => {
    console.log(`[WorkoutSummary] Image uploaded with ID: ${imageId}`);
    setPendingImage(imageId); // Store in session for immediate display
  };

  const handleImageError = (error: string) => {
    console.error(`[WorkoutSummary] Image upload error: ${error}`);
  };

  const handleContinue = async () => {
    // Validate workout name first
    if (!workoutName.trim()) {
      setShowNameError(true);
      return; // Don't continue
    }
    setShowNameError(false);

    console.log("=== SUMMARY SLIDE CONTINUE ===");
    console.log("Workout name:", workoutName);
    console.log("Workout notes:", workoutNotes);
    console.log("Pending image ID:", pendingImageId);

    if (currentWorkout) {
      try {
        console.log("=== BEFORE UPDATES ===");
        console.log(
          "currentWorkout.workout_exercises length:",
          currentWorkout?.workout_exercises?.length
        );
        console.log(
          "currentWorkout.workout_exercises:",
          currentWorkout?.workout_exercises
        );

        // Check for real changes
        const hasNameChanged = workoutName !== currentWorkout.name;
        const originalNotes = currentWorkout.notes || "";
        const autoGeneratedNotes =
          (currentWorkout.workout_exercises || [])
            .map((exercise) => `${exercise.name}:\n\n`)
            .join("\n") || "";
        const hasNotesChanged =
          workoutNotes !== originalNotes && workoutNotes !== autoGeneratedNotes;
        const hasImageChanged =
          pendingImageId !== (currentWorkout.image_id || null);

        console.log("=== CHANGE DETECTION ===");
        console.log("hasNameChanged:", hasNameChanged);
        console.log("hasNotesChanged:", hasNotesChanged);
        console.log("hasImageChanged:", hasImageChanged);

        // Update workout data (name/notes) if changed
        if (hasNameChanged || hasNotesChanged) {
          console.log("=== UPDATING METADATA ===");
          const updatedWorkout = {
            ...currentWorkout,
            name: workoutName,
            notes: workoutNotes,
            updated_at: new Date().toISOString(),
          };

          console.log(
            "About to call updateCurrentWorkout with workout_exercises:",
            updatedWorkout.workout_exercises?.length
          );
          updateCurrentWorkout(updatedWorkout);

          console.log("=== AFTER updateCurrentWorkout ===");
          const stateAfterUpdate =
            useUserSessionStore.getState().currentWorkout;
          console.log(
            "Store state workout_exercises:",
            stateAfterUpdate?.workout_exercises?.length
          );

          console.log("About to call API updateWorkout");
          await updateWorkout(updatedWorkout.id, updatedWorkout);

          console.log("=== AFTER API updateWorkout ===");
          const stateAfterAPI = useUserSessionStore.getState().currentWorkout;
          console.log(
            "Store state after API:",
            stateAfterAPI?.workout_exercises?.length
          );
          console.log("Workout metadata updated");
        }

        // ✅ SIMPLIFIED: Handle image with regular updateWorkout
        if (hasImageChanged && pendingImageId) {
          console.log("=== UPDATING IMAGE ===");
          console.log(
            "Store state before image update:",
            useUserSessionStore.getState().currentWorkout?.workout_exercises
              ?.length
          );

          console.log("Updating workout with image ID...");

          // 1. Update workout with image_id
          await updateWorkout(currentWorkout.id, { image_id: pendingImageId });

          // 2. Commit the temp image to permanent
          const commitResult = await imageService.commitImage(pendingImageId);
          if (!commitResult.success) {
            throw new Error(commitResult.error || "Failed to commit image");
          }

          // 3. Update session store with image_id
          updateCurrentWorkout({
            ...currentWorkout,
            image_id: pendingImageId,
          });

          // 4. Clear pending image after successful commit
          setPendingImage(null);

          console.log("=== AFTER IMAGE UPDATE ===");
          const stateAfterImage = useUserSessionStore.getState().currentWorkout;
          console.log(
            "Store state after image update:",
            stateAfterImage?.workout_exercises?.length
          );
          console.log("Image committed and workout updated");
        }

        if (hasNameChanged || hasNotesChanged || hasImageChanged) {
          console.log("=== REFRESHING TEMPLATES ===");
          const { fetchTemplates } = useWorkoutStore.getState();
          await fetchTemplates();

          console.log("=== AFTER fetchTemplates ===");
          const stateAfterTemplates =
            useUserSessionStore.getState().currentWorkout;
          console.log(
            "Store state after templates:",
            stateAfterTemplates?.workout_exercises?.length
          );
          console.log("Templates refreshed");
        } else {
          console.log("No real changes detected, skipping database updates");
        }

        console.log("=== FINAL STATE CHECK ===");
        const finalState = useUserSessionStore.getState().currentWorkout;
        console.log(
          "Final workout_exercises:",
          finalState?.workout_exercises?.length
        );
      } catch (error) {
        console.error("Failed to save workout:", error);
        console.log("=== ERROR STATE CHECK ===");
        const errorState = useUserSessionStore.getState().currentWorkout;
        console.log(
          "Workout_exercises after error:",
          errorState?.workout_exercises?.length
        );
      }
    }
    onContinue();
  };

  return (
    <YStack gap="$4" paddingBottom="$4">
      <Text fontSize="$4" fontWeight="bold">
        Workout Complete!
      </Text>

      <YStack gap="$2">
        <Input
          value={workoutName}
          onChangeText={handleNameChange}
          placeholder={selectedTemplate?.name || "Name your workout..."}
          placeholderTextColor="$textMuted"
          size="$4"
          borderColor={showNameError ? "$red9" : "$borderColor"} // ✅ Visual error indication
        />
        {showNameError && (
          <Text color="$red9" fontSize="$2">
            Please enter a workout name to continue
          </Text>
        )}
      </YStack>

      <YStack gap="$2">
        <Text fontSize="$4" fontWeight="600">
          Add a Photo
        </Text>

        {pendingImageId || currentWorkout?.image_id ? (
          <YStack alignItems="center" gap="$2">
            <WorkoutImage width={300} height={240} />
            <ImagePickerButton
              label="Change Photo"
              icon="camera"
              size="lg"
              onImageUploaded={handleImageUploaded}
              onError={handleImageError}
            />
          </YStack>
        ) : (
          <XStack justifyContent="center">
            <ImagePickerButton
              label="Add Photo"
              icon="camera"
              size="md"
              onImageUploaded={handleImageUploaded}
              onError={handleImageError}
            />
          </XStack>
        )}
      </YStack>

      <YStack gap="$2">
        <Text fontSize="$4" fontWeight="600">
          Notes
        </Text>
        <TextArea
          value={workoutNotes}
          onChangeText={setWorkoutNotes}
          placeholder="Add notes for your workout..."
          minHeight={300}
          backgroundColor="$background"
        />
      </YStack>

      <Button size="$4" backgroundColor="$primary" onPress={handleContinue}>
        Continue to Coach
      </Button>
    </YStack>
  );
}
