import React, { useState } from "react";
import { YStack, Text, Input, Button, TextArea } from "tamagui";
import { useUserSessionStore } from "@/stores/userSessionStore";
import { useWorkoutStore } from "@/stores/workout/WorkoutStore"; // ADD THIS IMPORT

interface WorkoutSummarySlideProps {
  onContinue: () => void;
  showContinueButton?: boolean;
}

export function WorkoutSummarySlide({
  onContinue,
  showContinueButton = true,
}: WorkoutSummarySlideProps) {
  const { currentWorkout, updateCurrentWorkout } = useUserSessionStore();
  const { updateWorkout } = useWorkoutStore(); // ADD THIS

  const [workoutName, setWorkoutName] = useState(currentWorkout?.name || "");
  const [workoutNotes, setWorkoutNotes] = useState(() => {
    // Pre-populate with exercise headings if no existing notes
    if (currentWorkout?.notes) {
      return currentWorkout.notes;
    }

    return (
      currentWorkout?.workout_exercises
        ?.map((exercise) => `${exercise.name}:\n\n`)
        .join("\n") || ""
    );
  });

  const handleNameChange = (name: string) => {
    setWorkoutName(name);
    if (currentWorkout) {
      updateCurrentWorkout({
        ...currentWorkout,
        name,
        updated_at: new Date().toISOString(),
      });
    }
  };

  const handleContinue = async () => {
    console.log("=== SUMMARY SLIDE CONTINUE ===");
    console.log("Workout name:", workoutName);
    console.log("Workout notes:", workoutNotes);

    if (currentWorkout) {
      const updatedWorkout = {
        ...currentWorkout,
        name: workoutName,
        notes: workoutNotes,
        updated_at: new Date().toISOString(),
      };

      // Update in session store
      updateCurrentWorkout(updatedWorkout);

      // Check for real changes
      const hasNameChanged = workoutName !== currentWorkout.name;
      const originalNotes = currentWorkout.notes || "";
      const autoGeneratedNotes =
        currentWorkout.workout_exercises
          ?.map((exercise) => `${exercise.name}:\n\n`)
          .join("\n") || "";
      const hasNotesChanged =
        workoutNotes !== originalNotes && workoutNotes !== autoGeneratedNotes;

      if (hasNameChanged || hasNotesChanged) {
        console.log("Real changes detected, updating database...");
        try {
          // Update workout in database
          await updateWorkout(updatedWorkout.id, updatedWorkout);
          console.log("Workout successfully saved to database");

          // Refresh templates to show updated name/notes
          const { fetchTemplates } = useWorkoutStore.getState();
          await fetchTemplates();
          console.log("Templates refreshed");
        } catch (error) {
          console.error("Failed to save workout or refresh templates:", error);
          // Could show a toast error here if needed
        }
      } else {
        console.log("No real changes detected, skipping database update");
      }
    }

    onContinue();
  };

  return (
    <YStack gap="$4" paddingBottom="$4">
      <Text fontSize="$6" fontWeight="bold">
        Workout Complete!
      </Text>

      <Input
        value={workoutName}
        onChangeText={handleNameChange}
        placeholder={currentWorkout?.name || "Name your workout..."}
        placeholderTextColor="$textMuted"
        size="$4"
      />

      <YStack gap="$2">
        <Text fontSize="$5" fontWeight="600">
          Notes
        </Text>

        <TextArea
          value={workoutNotes}
          onChangeText={setWorkoutNotes}
          placeholder="Add notes for your workout..."
          minHeight={300}
          backgroundColor="$background"
        />
      </YStack>

      <Button size="$4" backgroundColor="$primary" onPress={handleContinue}>
        Continue to Coach
      </Button>
    </YStack>
  );
}
